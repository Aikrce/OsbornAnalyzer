# HuiTu项目渐进式修改工作流程

**创建日期**: 2025-01-21  
**版本**: v1.0.0  
**适用范围**: 项目细节调整和功能优化

## 📋 工作流程概述

本工作流程确保每次修改都是渐进式的、可撤回的、可测试的，并保持完整的变更记录。

## 🔄 修改工作流程

### 阶段1: 修改准备 (Preparation)

#### 1.1 需求分析
- [ ] 明确修改目标和范围
- [ ] 分析现有代码结构
- [ ] 识别相关文件和组件
- [ ] 评估修改复杂度

#### 1.2 影响范围分析
- [ ] 分析代码依赖关系
- [ ] 识别可能受影响的组件
- [ ] 评估API接口影响
- [ ] 制定风险评估报告
- [ ] **平台分离策略分析** ⚠️
- [ ] **跨平台适配要求评估** ⚠️
- [ ] **移动端响应式设计考虑** ⚠️

#### 1.3 修改计划制定
- [ ] 制定详细的修改步骤
- [ ] 确定测试验证方案
- [ ] 准备回滚方案
- [ ] 设定修改完成标准

### 阶段2: 代码修改 (Implementation)

#### 2.1 创建修改分支
```bash
# 创建功能分支
git checkout -b feature/detail-adjustment-[功能名]

# 确保分支基于最新main
git rebase main
```

#### 2.2 渐进式代码修改
- [ ] 每次只修改一个小的功能点
- [ ] 保持代码的可读性和可维护性
- [ ] 遵循项目编码规范
- [ ] 添加必要的注释和文档
- [ ] **集成响应式设计hooks** ⚠️
- [ ] **考虑移动端触摸交互** ⚠️
- [ ] **适配不同屏幕尺寸** ⚠️
- [ ] **使用现有的移动端优化工具** ⚠️

#### 2.3 代码质量检查
- [ ] 运行TypeScript类型检查
- [ ] 执行ESLint代码检查
- [ ] 运行Prettier代码格式化
- [ ] 确保代码通过所有检查

#### 2.4 错误处理策略
- [ ] **Git操作错误处理**
  - [ ] 检查Git配置和权限
  - [ ] 处理分支冲突和合并错误
  - [ ] 验证远程仓库连接
  - [ ] 处理GitHub Actions中的Git错误
- [ ] **构建错误处理**
  - [ ] 检查依赖版本兼容性
  - [ ] 处理TypeScript编译错误
  - [ ] 解决ESLint规则冲突
  - [ ] 修复构建配置问题
- [ ] **部署错误处理**
  - [ ] 验证GitHub Pages配置
  - [ ] 检查构建产物完整性
  - [ ] 处理环境变量和密钥问题
  - [ ] 监控部署状态和日志

### 阶段3: 测试验证 (Testing)

#### 3.1 单元测试
- [ ] 运行相关组件的单元测试
- [ ] 添加新的测试用例（如需要）
- [ ] 确保测试覆盖率达到要求
- [ ] 验证测试结果

#### 3.2 集成测试
- [ ] 测试修改与其他组件的集成
- [ ] 验证API接口的兼容性
- [ ] 检查数据流是否正常
- [ ] 确保没有破坏现有功能

#### 3.3 功能验证
- [ ] 手动测试修改后的功能
- [ ] 验证边界条件和异常情况
- [ ] 检查用户界面是否正常
- [ ] 确保性能没有明显下降
- [ ] **跨平台兼容性测试** ⚠️
- [ ] **移动端响应式测试** ⚠️
- [ ] **触摸交互测试** ⚠️
- [ ] **不同屏幕尺寸测试** ⚠️

### 阶段4: 文档更新 (Documentation)

#### 4.1 代码文档更新
- [ ] 更新相关代码注释
- [ ] 修改API文档（如需要）
- [ ] 更新类型定义文档
- [ ] 确保文档与代码一致

#### 4.2 用户文档更新
- [ ] 更新用户指南（如需要）
- [ ] 修改功能说明文档
- [ ] 更新操作步骤说明
- [ ] 确保用户文档准确

#### 4.3 变更记录更新
- [ ] 更新CHANGELOG.md
- [ ] 记录修改的详细信息
- [ ] 标记修改类型和影响范围
- [ ] 添加修改日期和版本信息

### 阶段5: 代码审查 (Review)

#### 5.1 自我审查
- [ ] 检查代码质量和规范
- [ ] 验证测试覆盖情况
- [ ] 确认文档更新完整
- [ ] 检查是否有遗漏

#### 5.2 同行审查
- [ ] 提交Pull Request
- [ ] 请求代码审查
- [ ] 根据反馈进行修改
- [ ] 确保审查通过

### 阶段6: 部署和监控 (Deployment)

#### 6.1 合并代码
```bash
# 合并到主分支
git checkout main
git merge feature/detail-adjustment-[功能名]

# 删除功能分支
git branch -d feature/detail-adjustment-[功能名]
```

#### 6.2 部署验证
- [ ] 在测试环境部署
- [ ] 进行完整的功能测试
- [ ] 验证性能指标
- [ ] 确保部署成功

#### 6.3 生产监控
- [ ] 监控生产环境运行状态
- [ ] 检查错误日志
- [ ] 验证用户反馈
- [ ] 确保系统稳定

#### 6.4 错误监控和诊断
- [ ] **GitHub Actions错误处理**
  - [ ] 监控工作流执行状态
  - [ ] 分析构建和部署日志
  - [ ] 处理Git操作错误 (exit code 128)
  - [ ] 验证环境变量和权限配置
- [ ] **部署错误诊断**
  - [ ] 检查GitHub Pages设置
  - [ ] 验证构建产物路径
  - [ ] 测试网站可访问性
  - [ ] 处理缓存和CDN问题
- [ ] **运行时错误处理**
  - [ ] 监控JavaScript控制台错误
  - [ ] 检查网络请求失败
  - [ ] 处理用户界面异常
  - [ ] 验证功能完整性

## 🚨 回滚策略

### 快速回滚
```bash
# 回滚到上一个稳定版本
git revert [commit-hash]

# 或者回滚到特定标签
git checkout v2.0.0-stable
```

### 回滚检查清单
- [ ] 确认回滚原因和影响
- [ ] 备份当前状态
- [ ] 执行回滚操作
- [ ] 验证回滚后的功能
- [ ] 更新相关文档
- [ ] 通知相关人员

### 错误回滚策略
- [ ] **Git错误回滚**
  - [ ] 处理合并冲突回滚
  - [ ] 恢复被意外删除的文件
  - [ ] 修复分支状态问题
  - [ ] 清理无效的提交记录
- [ ] **构建错误回滚**
  - [ ] 回滚依赖版本变更
  - [ ] 恢复构建配置
  - [ ] 修复环境配置问题
  - [ ] 清理构建缓存
- [ ] **部署错误回滚**
  - [ ] 回滚到上一个稳定版本
  - [ ] 修复GitHub Pages配置
  - [ ] 恢复正确的构建产物
  - [ ] 清理部署缓存

## 📊 质量保证检查清单

### 代码质量
- [ ] TypeScript类型检查通过
- [ ] ESLint检查无错误
- [ ] 代码格式化规范
- [ ] 测试覆盖率达标

### 功能质量
- [ ] 功能按预期工作
- [ ] 没有引入新的bug
- [ ] 性能没有明显下降
- [ ] 用户体验良好

### 文档质量
- [ ] 代码注释完整
- [ ] API文档准确
- [ ] 用户文档更新
- [ ] 变更记录详细

## 🔍 监控和反馈

### 修改后监控
- [ ] 监控系统运行状态
- [ ] 收集用户反馈
- [ ] 分析性能指标
- [ ] 检查错误日志

### 持续改进
- [ ] 分析修改效果
- [ ] 收集改进建议
- [ ] 优化工作流程
- [ ] 更新最佳实践

## 📝 工作流程记录模板

### 修改记录模板
```markdown
## 修改记录 - [日期]

### 修改信息
- **修改类型**: [新增/变更/修复/移除]
- **影响范围**: [具体描述]
- **修改文件**: [文件列表]
- **修改人员**: [姓名]

### 修改内容
- [详细描述修改内容]

### 测试结果
- [测试结果和验证情况]

### 影响分析
- [影响范围分析结果]

### 回滚方案
- [回滚步骤和注意事项]
```

## 🎯 最佳实践建议

### 修改原则
1. **渐进式**: 每次修改一个小的功能点
2. **可撤回**: 每次修改都可以独立回滚
3. **可测试**: 修改后可以立即验证
4. **文档同步**: 修改后更新相关文档
5. **平台兼容**: 考虑跨平台兼容性 ⚠️
6. **响应式设计**: 适配不同设备和屏幕尺寸 ⚠️

## 📱 平台分离策略和跨平台适配要求

### 平台分离架构
```
Web平台 (apps/web):
├── React: ^18.3.1 (稳定版本)
├── 目标: 浏览器环境
├── 响应式设计: 必需
└── 移动端适配: 必需

移动端平台 (apps/android):
├── React: 19.1.1 (最新版本)
├── 目标: React Native环境
├── 原生API: 相机、GPS、推送
└── 触摸交互: 必需

iOS平台 (apps/ios):
├── React Native
├── 目标: iOS原生环境
├── 原生API: iOS特定功能
└── 触摸交互: 必需
```

### 跨平台适配要求

#### 1. 响应式设计必须项
- [ ] 使用 `useResponsive` hook 检测设备类型
- [ ] 适配移动端、平板、桌面三种布局
- [ ] 考虑触摸交互和鼠标交互的差异
- [ ] 优化移动端的性能和加载速度

#### 2. 移动端优化必须项
- [ ] 使用 `useMobile` hook 获取移动端特性
- [ ] 集成 `mobileOptimization.ts` 工具函数
- [ ] 考虑网络状况和性能优化
- [ ] 适配不同屏幕尺寸和方向

#### 3. 平台特定功能
- [ ] Web端: 使用 localStorage、DOM API
- [ ] Android端: 使用 AsyncStorage、原生API
- [ ] iOS端: 使用 AsyncStorage、iOS特定API
- [ ] 共享逻辑: 使用 shared-utils 包

#### 4. 组件设计原则
- [ ] 组件必须支持响应式布局
- [ ] 按钮和交互元素适配触摸操作
- [ ] 文本和图标大小适配不同屏幕
- [ ] 考虑移动端的滚动和手势

### 常见问题和解决方案

#### 问题1: 忽略平台分离策略
**症状**: 新组件没有考虑移动端适配
**解决方案**: 
1. 立即集成 `useResponsive` hook
2. 添加移动端特定的样式和交互
3. 测试不同屏幕尺寸的显示效果

#### 问题2: 没有使用现有的移动端工具
**症状**: 重复造轮子，没有利用现有优化
**解决方案**:
1. 检查 `apps/web/src/hooks/useMobile.ts`
2. 使用 `apps/web/src/utils/mobileOptimization.ts`
3. 参考现有的移动端组件设计

#### 问题3: 跨平台兼容性问题
**症状**: 功能在某个平台上不工作
**解决方案**:
1. 使用平台检测条件渲染
2. 为不同平台提供不同的实现
3. 在 shared-utils 中提供统一的接口

### 质量保证
1. **自动化优先**: 使用自动化工具进行检查
2. **测试驱动**: 先写测试，再写代码
3. **文档先行**: 先更新文档，再修改代码
4. **持续监控**: 修改后持续监控系统状态

### 团队协作
1. **及时沟通**: 及时与团队成员沟通修改情况
2. **代码审查**: 所有修改都要经过代码审查
3. **知识分享**: 及时分享修改经验和最佳实践
4. **持续学习**: 从每次修改中学习和改进

## 🚨 常见错误处理指南

### GitHub Actions错误处理

#### Git操作错误 (Exit Code 128)
**症状**: `The process '/usr/bin/git' failed with exit code 128`
**原因分析**:
- Git配置不完整或权限不足
- 远程仓库连接问题
- 分支操作冲突
- 环境变量缺失

**解决方案**:
```bash
# 1. 检查Git配置
git config --list
git config user.name
git config user.email

# 2. 验证远程仓库连接
git remote -v
git fetch origin

# 3. 检查分支状态
git branch -a
git status

# 4. 修复权限问题
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

#### 构建错误处理
**症状**: 构建失败，依赖冲突
**解决方案**:
```bash
# 1. 清理依赖缓存
rm -rf node_modules
rm -rf pnpm-lock.yaml
pnpm install

# 2. 检查依赖版本
pnpm list
pnpm outdated

# 3. 修复版本冲突
pnpm update
```

#### 部署错误处理
**症状**: GitHub Pages部署失败
**解决方案**:
1. **检查GitHub Pages设置**
   - 确认Source设置为"GitHub Actions"
   - 验证仓库权限设置
   - 检查Pages设置中的分支选择

2. **验证构建产物**
   ```bash
   # 检查构建输出
   ls -la apps/web/dist/
   
   # 验证文件完整性
   find apps/web/dist -name "*.html" -o -name "*.js" -o -name "*.css"
   ```

3. **修复路径配置**
   ```typescript
   // vite.config.ts
   export default defineConfig({
     base: '/OsbornAnalyzer/', // 确保路径正确
     // ...其他配置
   })
   ```

### 运行时错误处理

#### JavaScript控制台错误
**监控方法**:
```javascript
// 添加全局错误处理
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  // 发送错误报告到监控服务
});

// 添加未处理的Promise拒绝处理
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  // 发送错误报告
});
```

#### 网络请求错误
**处理策略**:
```typescript
// API请求错误处理
const handleApiError = (error: any) => {
  if (error.response) {
    // 服务器响应错误
    console.error('API Error:', error.response.status, error.response.data);
  } else if (error.request) {
    // 网络错误
    console.error('Network Error:', error.message);
  } else {
    // 其他错误
    console.error('Error:', error.message);
  }
};
```

### 错误预防策略

#### 1. 预防性检查
- [ ] 每次提交前运行完整测试套件
- [ ] 使用pre-commit hooks进行代码检查
- [ ] 定期更新依赖版本
- [ ] 监控构建和部署状态

#### 2. 监控和告警
- [ ] 设置GitHub Actions失败通知
- [ ] 监控网站可用性
- [ ] 跟踪用户反馈和错误报告
- [ ] 定期检查日志文件

#### 3. 快速响应机制
- [ ] 建立错误响应流程
- [ ] 准备回滚方案
- [ ] 维护紧急联系方式
- [ ] 制定错误修复优先级

### 错误记录模板

```markdown
## 错误记录 - [日期]

### 错误信息
- **错误类型**: [Git/构建/部署/运行时]
- **错误级别**: [低/中/高/紧急]
- **影响范围**: [具体描述]
- **发现时间**: [时间戳]

### 错误详情
- **错误消息**: [具体错误信息]
- **重现步骤**: [如何重现错误]
- **环境信息**: [操作系统、浏览器、版本等]

### 解决方案
- [ ] 立即修复措施
- [ ] 长期解决方案
- [ ] 预防措施
- [ ] 相关文档更新

### 影响评估
- **用户影响**: [影响程度和范围]
- **业务影响**: [对业务的影响]
- **技术债务**: [产生的技术债务]

### 后续行动
- [ ] 监控修复效果
- [ ] 更新错误处理流程
- [ ] 团队知识分享
- [ ] 流程改进建议
```

---

**工作流程维护者**: HuiTu开发团队  
**最后更新**: 2025-01-21  
**下次审核**: 2025-02-21
